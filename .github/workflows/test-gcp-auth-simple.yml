name: Test GCP Authentication (Simple)

on:
  workflow_dispatch:
    inputs:
      workflow_type:
        description: "Type of authentication to test"
        required: true
        default: "service-account"
        type: choice
        options:
          - service-account
          - workload-identity
  push:
    branches: [main, develop]
    paths:
      - "src/gcp/**"
      - "gcp-config.yaml"
      - ".github/workflows/test-gcp-auth-simple.yml"

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: us-central1

jobs:
  test-auth-simple:
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Check Required Secrets
        run: |
          echo "=== GCP Service Account Authentication Test ==="
          echo "Checking required secrets for Service Account authentication..."
          if [ -z "${{ secrets.GCP_CREDENTIALS_JSON }}" ]; then
            echo "❌ GCP_CREDENTIALS_JSON not configured"
            echo "Please configure GCP service account credentials"
            echo "Use: .github/workflows/test-gcp-auth.yml for Workload Identity Federation"
            exit 1
          fi
          if [ -z "${{ secrets.GCP_PROJECT_ID }}" ]; then
            echo "❌ GCP_PROJECT_ID not configured"
            echo "Please configure GCP project ID"
            echo "Use: .github/workflows/test-gcp-auth.yml for Workload Identity Federation"
            exit 1
          fi
          echo "✅ All required secrets are configured for Service Account"

      - name: Authenticate to Google Cloud (Simple)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS_JSON }}

      - name: Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Verify Authentication
        run: |
          echo "Testing GCP authentication..."
          # Check if we're authenticated
          gcloud auth list --filter=status:ACTIVE --format="value(account)"
          # Check current project configuration
          gcloud config get-value project
          echo "✅ Authentication successful!"

      - name: Test Basic GCP Commands
        run: |
          echo "Testing basic GCP commands..."
          # Test basic gcloud commands that don't require elevated permissions
          gcloud version
          gcloud config list
          echo "✅ Basic GCP commands working!"

      - name: Test Project Access (Basic)
        run: |
          echo "Testing basic project access..."
          # Only test if we can see the project ID in config
          gcloud config get-value project
          echo "✅ Basic project access verified!"

      - name: Cleanup and Summary
        if: always()
        run: |
          echo "=== GCP Authentication Test Summary ==="
          echo "✅ Authentication step completed"
          echo "✅ Basic GCP CLI commands working"
          echo "✅ Project configuration verified"
          echo ""
          echo "Note: This workflow tests basic authentication only."
          echo "For full GCP access, ensure the service account has appropriate IAM roles."
          echo "Required roles: roles/viewer (minimum), roles/editor (for full access)"
